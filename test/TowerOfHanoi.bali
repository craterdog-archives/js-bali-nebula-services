[
    $description: "
This class encapsulates a /Tower of Hanoi/ game with three pegs (A, B, and C) and a
parameterized number of disks. To play the game do the following:
 # Initialize a game with 3 disks.
`$game := [:]($type: <bali:/?name=bali.games.TowerOfHanoi>, $disks: 3)`
 # Play the game.
`game.play()`

The output should be:
`
 1. Move top disk on peg A to peg C
 2. Move top disk on peg A to peg B
 3. Move top disk on peg C to peg B
 4. Move top disk on peg A to peg C
 5. Move top disk on peg B to peg A
 6. Move top disk on peg B to peg C
 7. Move top disk on peg A to peg C
`
"($mediatype: "application/bsmd")
    $parameters: [
        $disks: [
            $description: "The number of disks."
            $type: Number(1..infinity)
            $default: 5
        ]
    ]
    $attributes: [
        $pegs: [
            $description: "The three pegs (A, B and C) that are used to hold the disks."
            $type: Map(Stack(Number(1..infinity)))
            $default: 5
        ]
        $steps: [
            $description: "The steps needed to move the disks."
            $type: List(Text)
        ]
    ]
    $messages: [
        $play: [
            $description: "This message causes the game to (re)initialize itself and play the game."
            $result: Map(Number(1..infinity), Text)
        ]
        $moveTower: [
            $description: "This message causes the game to move a tower of disks of a certain height from one peg to another peg using a third peg as a buffer."
            $parameters: [
                $height: [
                    $description: "The height of the tower to be moved."
                    $type: Number(1..infinity)
                ]
                $fromPeg: [
                    $description: "The peg from which the disks originate."
                    $type: Text
                ]
                $toPeg: [
                    $description: "The peg to which the disks should be moved."
                    $type: Text
                ]
                $withPeg: [
                    $description: "The peg to use to buffer the disks during the move."
                    $type: Text
                ]
            ]
        ]($private)
        $moveDisk: [
            $description: "This message causes the game to move the top disk from one peg to another."
            $parameters: [
                $fromPeg: [
                    $description: "The peg from which the disk originates."
                    $type: Text
                ]
                $toPeg: [
                    $description: "The peg to which the disk should be moved."
                    $type: Text
                ]
            ]
        ]($private)
    ]
    $procedures: [
        $play: [
            $source: {
                $pegs := [
                    "peg A": []($type: Stack)
                    "peg B": []($type: Stack)
                    "peg C": []($type: Stack)
                ]
                $steps := []
                with each $n in [disks..1] do {
                    pegs["peg A"].push(n)
                }
                target.moveTower(disks, "peg A", "peg C", "peg B")
                return steps.asMap()
            }
            $instructions: "
1.EvaluateStatement:
PUSH DOCUMENT `3`
INVOKE $catalog WITH PARAMETER
PUSH DOCUMENT `"peg A"`
PUSH DOCUMENT `0`
INVOKE $list WITH PARAMETER
PUSH DOCUMENT `1`
INVOKE $catalog WITH PARAMETER
PUSH DOCUMENT `$type`
LOAD VARIABLE $Stack
INVOKE $setValue WITH 3 PARAMETERS
INVOKE $setParameters WITH 2 PARAMETERS
INVOKE $setValue WITH 3 PARAMETERS
PUSH DOCUMENT `"peg B"`
PUSH DOCUMENT `0`
INVOKE $list WITH PARAMETER
PUSH DOCUMENT `1`
INVOKE $catalog WITH PARAMETER
PUSH DOCUMENT `$type`
LOAD VARIABLE $Stack
INVOKE $setValue WITH 3 PARAMETERS
INVOKE $setParameters WITH 2 PARAMETERS
INVOKE $setValue WITH 3 PARAMETERS
PUSH DOCUMENT `"peg C"`
PUSH DOCUMENT `0`
INVOKE $list WITH PARAMETER
PUSH DOCUMENT `1`
INVOKE $catalog WITH PARAMETER
PUSH DOCUMENT `$type`
LOAD VARIABLE $Stack
INVOKE $setValue WITH 3 PARAMETERS
INVOKE $setParameters WITH 2 PARAMETERS
INVOKE $setValue WITH 3 PARAMETERS
STORE VARIABLE $pegs

2.EvaluateStatement:
PUSH DOCUMENT `0`
INVOKE $list WITH PARAMETER
STORE VARIABLE $steps

3.WithStatement:
LOAD VARIABLE $disks
PUSH DOCUMENT `1`
INVOKE $range WITH 2 PARAMETERS
INVOKE $iterator WITH PARAMETER
STORE VARIABLE $_iterator_1_

3.1.ConditionClause:
LOAD VARIABLE $_iterator_1_
INVOKE $hasNext WITH PARAMETER
JUMP TO 3.WithStatementDone ON FALSE
LOAD VARIABLE $_iterator_1_
INVOKE $getNext WITH PARAMETER
STORE VARIABLE $n

3.1.1.EvaluateStatement:
LOAD VARIABLE $pegs
PUSH DOCUMENT `"peg A"`
INVOKE $getValue WITH 2 PARAMETERS
PUSH DOCUMENT `1`
INVOKE $list WITH PARAMETER
LOAD VARIABLE $n
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $push ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

3.ConditionRepeat:
JUMP TO 3.1.ConditionClause

3.WithStatementDone:
SKIP INSTRUCTION

4.EvaluateStatement:
LOAD VARIABLE $target
PUSH DOCUMENT `4`
INVOKE $list WITH PARAMETER
LOAD VARIABLE $disks
INVOKE $addItem WITH 2 PARAMETERS
PUSH DOCUMENT `"peg A"`
INVOKE $addItem WITH 2 PARAMETERS
PUSH DOCUMENT `"peg C"`
INVOKE $addItem WITH 2 PARAMETERS
PUSH DOCUMENT `"peg B"`
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $moveTower ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

5.ReturnStatement:
LOAD VARIABLE $steps
EXECUTE $asMap ON TARGET
STORE VARIABLE $_result_
LOAD VARIABLE $_result_
HANDLE RESULT

"($mediatype: "application/basm")
            $bytecode: [
                '2801'
                'A801'
                '2802'
                '2803'
                'A802'
                '2804'
                'A801'
                '2805'
                '6001'
                'B803'
                'B004'
                'B803'
                '2806'
                '2803'
                'A802'
                '2804'
                'A801'
                '2805'
                '6001'
                'B803'
                'B004'
                'B803'
                '2807'
                '2803'
                'A802'
                '2804'
                'A801'
                '2805'
                '6001'
                'B803'
                'B004'
                'B803'
                '8002'
                '2803'
                'A802'
                '8003'
                '6004'
                '2804'
                'B005'
                'A806'
                '8005'
                '6005'
                'A807'
                '183A'
                '6005'
                'A808'
                '8006'
                '6002'
                '2802'
                'B009'
                '2804'
                'A802'
                '6006'
                'B00A'
                'D801'
                '8007'
                '002A'
                '0000'
                '6008'
                '2808'
                'A802'
                '6004'
                'B00A'
                '2802'
                'B00A'
                '2807'
                'B00A'
                '2806'
                'B00A'
                'D802'
                '8007'
                '6003'
                'D003'
                '8007'
                '6007'
                'E800'
            ]
        ]
        $moveTower: [
            $source: {
                $result := ""
                if height then {
                    target.moveTower(height - 1, fromPeg, withPeg, toPeg)
                    target.moveDisk(fromPeg, toPeg)
                    target.moveTower(height - 1, withPeg, toPeg, fromPeg)
                }
                return result
            }
            $instructions: "
1.EvaluateStatement:
PUSH DOCUMENT `""`
STORE VARIABLE $result

2.IfStatement:
SKIP INSTRUCTION

2.1.ConditionClause:
LOAD VARIABLE $height
JUMP TO 2.IfStatementDone ON FALSE

2.1.1.EvaluateStatement:
LOAD VARIABLE $target
PUSH DOCUMENT `4`
INVOKE $list WITH PARAMETER
LOAD VARIABLE $height
PUSH DOCUMENT `1`
INVOKE $difference WITH 2 PARAMETERS
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $fromPeg
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $withPeg
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $toPeg
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $moveTower ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

2.1.2.EvaluateStatement:
LOAD VARIABLE $target
PUSH DOCUMENT `2`
INVOKE $list WITH PARAMETER
LOAD VARIABLE $fromPeg
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $toPeg
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $moveDisk ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

2.1.3.EvaluateStatement:
LOAD VARIABLE $target
PUSH DOCUMENT `4`
INVOKE $list WITH PARAMETER
LOAD VARIABLE $height
PUSH DOCUMENT `1`
INVOKE $difference WITH 2 PARAMETERS
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $withPeg
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $toPeg
INVOKE $addItem WITH 2 PARAMETERS
LOAD VARIABLE $fromPeg
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $moveTower ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

2.IfStatementDone:
SKIP INSTRUCTION

3.ReturnStatement:
LOAD VARIABLE $result
STORE VARIABLE $_result_
LOAD VARIABLE $_result_
HANDLE RESULT

"($mediatype: "application/basm")
            $bytecode: [
                '2801'
                '8001'
                '0000'
                '6002'
                '182D'
                '6003'
                '2802'
                'A801'
                '6002'
                '2803'
                'B002'
                'B003'
                '6004'
                'B003'
                '6005'
                'B003'
                '6006'
                'B003'
                'D801'
                '8007'
                '6003'
                '2804'
                'A801'
                '6004'
                'B003'
                '6006'
                'B003'
                'D802'
                '8007'
                '6003'
                '2802'
                'A801'
                '6002'
                '2803'
                'B002'
                'B003'
                '6005'
                'B003'
                '6006'
                'B003'
                '6004'
                'B003'
                'D801'
                '8007'
                '0000'
                '6001'
                '8007'
                '6007'
                'E800'
            ]
        ]
        $moveDisk: [
            $source: {
                $disk := pegs[fromPeg].pop()
                pegs[toPeg].push(disk)
                steps.append("Move disk {disk} from {fromPeg} to {toPeg}.")
            }
            $instructions: "
1.EvaluateStatement:
LOAD VARIABLE $pegs
LOAD VARIABLE $fromPeg
INVOKE $getValue WITH 2 PARAMETERS
EXECUTE $pop ON TARGET
STORE VARIABLE $disk

2.EvaluateStatement:
LOAD VARIABLE $pegs
LOAD VARIABLE $toPeg
INVOKE $getValue WITH 2 PARAMETERS
PUSH DOCUMENT `1`
INVOKE $list WITH PARAMETER
LOAD VARIABLE $disk
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $push ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

3.EvaluateStatement:
LOAD VARIABLE $steps
PUSH DOCUMENT `1`
INVOKE $list WITH PARAMETER
PUSH DOCUMENT `"Move disk {disk} from {fromPeg} to {toPeg}."`
INVOKE $addItem WITH 2 PARAMETERS
EXECUTE $append ON TARGET WITH PARAMETERS
STORE VARIABLE $_result_

"($mediatype: "application/basm")
            $bytecode: [
                '6001'
                '6002'
                'B001'
                'D001'
                '8003'
                '6001'
                '6004'
                'B001'
                '2801'
                'A802'
                '6003'
                'B003'
                'D802'
                '8005'
                '6006'
                '2801'
                'A802'
                '2802'
                'B003'
                'D803'
                '8005'
            ]
        ]
    ]
]($type: Class)
